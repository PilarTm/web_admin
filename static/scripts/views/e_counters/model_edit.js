var E_COUNTERS_MODAL_EDIT=Backbone.View.extend({template:"#modal_edit_tpl",is_add:!1,is_changed:!1,initialize:function(e,t,n,r,i){this.is_add=e.get("id")==0,this.model=e.clone(),this.collection=t,this.marks=n,this.models=r,this.callback=i,this.listenTo(this.marks,"sync",this.render),this.listenTo(this.models,"sync",this.render);var s=this;this.listenTo(this.model,"change:model_id",this.field_status_model_id),this.listenTo(this.model,"change:serial",this.field_status_serial),this.listenTo(this.model,"change:num_485",this.field_status_num485),this.listenTo(this.model,"change:converter_id",this.field_status_converter_id),this.listenTo(this.model,"change:concentrator_id",this.field_status_concentrator_id),this.listenTo(this.model,"change",function(){this.is_changed=s.model._changing,this.btn_status()}),this.render()},btn_status:function(){var e=this;$("#save").attr("class",function(){return"btn "+(e.model.isValid()?"btn-accent":"btn-default disabled")})},render:function(){if(!this.marks.length||!this.models.length)return;var e=_.template($(this.template).html());this.$el=$(e({e_counters:this.model,marks:this.marks,models:this.models})).modal("show");var t=this;$(this.$el).on("hidden.bs.modal",function(){$(this).remove(),toastr.remove(),t.is_changed&&t.model.get("id")&&(t.is_add?toastr.success("Электросчетчик добавлен в систему","Успешно"):toastr.success("Электросчетчик изменился.","Успешно")),typeof t.callback!="undefined"&&t.callback()}).on("shown.bs.modal",function(){!t.model.get("converter_id")&&!t.model.get("concentrator_id")?t.model.set("converter_id",Number($("#converter_id").val())):t.model.get("converter_id")?$("#converter_id").val(t.model.get("converter_id")):t.model.get("concentrator_id")&&(console.log(t.model.get("concentrator_id")),$("#concentrator_id").val(t.model.get("concentrator_id")).trigger("change"));if(t.model.get("model_id")){var e=t.models.findWhere({id:t.model.get("model_id")});typeof e!="undefined"&&($("#mark").val(e.get("mark_id")).trigger("change"),$("#model").val(e.get("id")).trigger("change"))}t.field_status_model_id(),t.field_status_serial(),t.field_status_num485(),t.field_status_converter_id(),t.field_status_concentrator_id(),t.btn_status()})},field_status_model_id:function(){this.model.get("model_id")?$("#model").closest(".form-group").removeClass("has-warning").addClass("has-success"):$("#model").closest(".form-group").addClass("has-warning").removeClass("has-success")},field_status_concentrator_id:function(){this.model.get("concentrator_id")?$("#concentrator_id").closest(".form-group").removeClass("has-warning").addClass("has-success"):$("#concentrator_id").closest(".form-group").addClass("has-warning").removeClass("has-success")},field_status_converter_id:function(){this.model.get("converter_id")?$("#converter_id").closest(".form-group").removeClass("has-warning").addClass("has-success"):$("#converter_id").closest(".form-group").addClass("has-warning").removeClass("has-success")},field_status_serial:function(){this.model.get("serial")?$("#serial").closest(".form-group").removeClass("has-warning").addClass("has-success"):$("#serial").closest(".form-group").addClass("has-warning").removeClass("has-success")},field_status_num485:function(){this.model.get("num_485")?$("#num_485").closest(".form-group").removeClass("has-warning").addClass("has-success"):$("#num_485").closest(".form-group").addClass("has-warning").removeClass("has-success")},events:{"change #mark":function(e){Number($(e.target).val())?$("#model").closest(".form-group").show():$("#model").closest(".form-group").hide(),$("#model").find("option").remove();var t=this,n=this.models.findWhere({id:t.model.get("model_id")});typeof n=="undefined"&&(n=new MODEL_E_COUNTERS_COLLECTIONS),_.each(this.models.where({mark_id:Number($(e.target).val())}),function(r,i){$("#model").append($("<option/>").attr("value",r.get("id")).text(r.escape("title"))),!i&&n.get("mark_id")!=Number($(e.target).val())&&t.model.set("model_id",r.get("id"))}),Number($(e.target).val())?$("#mark").closest(".form-group").addClass("has-success").removeClass("has-warning"):$("#mark").closest(".form-group").removeClass("has-success").addClass("has-warning")},"keyup #serial":function(e){this.model.set("serial",$(e.target).val())},"keyup #num_485":function(e){this.model.set("num_485",$(e.target).val())},"keyup #title":function(e){this.model.set("title",$(e.target).val())},"change #model":function(e){this.model.set("model_id",Number($(e.target).val()))},"change #converter_id":function(e){this.model.set("concentrator_id",0),$("#concentrator_id").val(0),this.model.set("converter_id",$(e.target).val())},"change #concentrator_id":function(e){this.model.set("converter_id",0),$("#converter_id").val(0),this.model.set("concentrator_id",$(e.target).val())},"click #save":function(e){if(!this.model.isValid())return!1;var t=this;this.model.save(null,{error:function(){toastr.error("Электросчетчик не добавлен в систему","Ошибка")},success:function(){$(t.$el).modal("hide"),t.collection.fetch()}})}}});