var CONVERTER_MODAL_EDIT=Backbone.View.extend({template:"#modal_edit_converter_tpl",is_add:!1,is_changed:!1,initialize:function(e,t,n,r,i){this.is_add=e.get("id")==0,this.model=e.clone(),this.collection=t,this.marks=n,this.models=r,this.callback=i,this.listenTo(this.model,"change",function(){this.is_changed=this.model._changing}),this.listenTo(this.marks,"sync",this.render),this.listenTo(this.models,"sync",this.render),this.listenTo(this.model,"change",this.btn_status),this.listenTo(this.model,"change:model_id",this.field_status_mark_id),this.listenTo(this.model,"change:ip",this.field_status_ip),this.listenTo(this.model,"change:port",this.field_status_port),this.render()},btn_status:function(){var e=this.model.isValid()?"btn btn-accent":"btn btn-default disabled";$("#save").attr("class",e)},render:function(){if(!this.marks.length||!this.models.length)return;var e=_.template($(this.template).html());this.$el=$(e({converter:this.model,marks:this.marks,models:this.models})).modal("show");var t=this;$(this.$el).on("hidden.bs.modal",function(){$(this).remove(),toastr.remove(),t.is_changed&&t.model.get("id")&&(t.is_add?toastr.success("Конвертер добавлен в систему","Успешно"):toastr.success("Конвертер изменился.","Успешно")),typeof t.callback!="undefined"&&t.callback()}).on("shown.bs.modal",function(){t.btn_status();if(t.model.get("model_id")){var e=t.models.findWhere({id:t.model.get("model_id")});typeof e!="undefined"&&($("#mark").val(e.get("mark_id")).trigger("change"),$("#model").val(e.get("id")).trigger("change"))}t.field_status_mark_id(),t.field_status_ip(),t.field_status_port()})},field_status_mark_id:function(){this.model.get("model_id")?$("#model").closest(".form-group").removeClass("has-warning").addClass("has-success"):$("#model").closest(".form-group").addClass("has-warning").removeClass("has-success")},field_status_ip:function(){class_empty="has-warning",class_success="has-success",class_invalid="has-error",this.model.get("ip")==""?$("#ip").closest(".form-group").removeClass(class_success).removeClass(class_invalid).addClass(class_empty):this.model._validate_ip()?$("#ip").closest(".form-group").removeClass(class_empty).removeClass(class_invalid).addClass(class_success):$("#ip").closest(".form-group").removeClass(class_empty).removeClass(class_success).addClass(class_invalid)},field_status_port:function(){class_empty="has-warning",class_success="has-success",class_invalid="has-error",this.model.get("port")==0?$("#port").closest(".form-group").removeClass(class_success).removeClass(class_invalid).addClass(class_empty):this.model._validate_port()?$("#port").closest(".form-group").removeClass(class_empty).removeClass(class_invalid).addClass(class_success):$("#port").closest(".form-group").removeClass(class_empty).removeClass(class_success).addClass(class_invalid)},events:{"change #mark":function(e){var t=this;$("#model").closest(".form-group").show(),_.each(this.models.where({mark_id:Number($(e.target).val())}),function(e,n){$("#model").append($("<option/>").attr("value",e.get("id")).text(e.escape("title"))),n||t.model.set("model_id",e.get("id"))}),$(e.target).val()?$("#mark").closest(".form-group").removeClass("has-warning").addClass("has-success"):$("#mark").closest(".form-group").addClass("has-warning").removeClass("has-success")},"keyup #ip":function(e){this.model.set("ip",$(e.target).val())},"keyup #port":function(e){this.model.set("port",Number($(e.target).val()))},"change #port":function(e){this.model.set("port",Number($(e.target).val()))},"keyup #login":function(e){this.model.set("login",$(e.target).val())},"keyup #password":function(e){this.model.set("password",$(e.target).val())},"keyup #title":function(e){this.model.set("title",$(e.target).val())},"click #save":function(e){var t=this;this.model.save(null,{error:function(){toastr.error("Конвертер не добавлен в систему","Ошибка")},success:function(){$(t.$el).modal("hide"),t.collection.fetch()}})}}});